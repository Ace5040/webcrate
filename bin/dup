#!/bin/bash

SCRIPT=`realpath $0`
SCRIPTPATH=`dirname $SCRIPT`

cd $SCRIPTPATH/..

source .env

docker run --rm --env-file=$(pwd)/.env \
  -v $SITES_PATH:/sites \
  -v $(pwd)/config/users:/webcrate/users:ro \
  -v $(pwd)/config/php-pool-templates:/webcrate/custom_templates:ro \
  -v $(pwd)/config/letsencrypt:/webcrate/letsencrypt \
  -v webcrate_nginx_configs_volume:/webcrate/nginx_configs \
  -v webcrate_ssl_configs_volume:/webcrate/ssl_configs \
  -v webcrate_php7_pools_volume:/webcrate/php-fpm.d \
  -v webcrate_php73_pools_volume:/webcrate/php73-fpm.d \
  -v webcrate_php5_pools_volume:/webcrate/php56-fpm.d \
  -v webcrate_dnsmasq_hosts_volume:/webcrate/dnsmasq_hosts \
  ace5040/webcrate-utils:stable \
  /webcrate/parse-users.py

docker run --rm --env-file=$(pwd)/.env \
  -v $SITES_PATH:/sites \
  -v $(pwd)/config/users:/webcrate/users:ro \
  -v $(pwd)/config/services:/webcrate/services:ro \
  -v $(pwd)/config/php-pool-templates:/webcrate/custom_templates:ro \
  -v $(pwd)/config/letsencrypt:/webcrate/letsencrypt \
  -v webcrate_nginx_configs_volume:/webcrate/nginx_configs \
  -v webcrate_ssl_configs_volume:/webcrate/ssl_configs \
  -v webcrate_php7_pools_volume:/webcrate/php-fpm.d \
  -v webcrate_php73_pools_volume:/webcrate/php73-fpm.d \
  -v webcrate_php5_pools_volume:/webcrate/php56-fpm.d \
  -v webcrate_dnsmasq_hosts_volume:/webcrate/dnsmasq_hosts \
  ace5040/webcrate-utils:stable \
  /webcrate/parse-services.py

docker-compose --project-name webcrate up --remove-orphans -d
