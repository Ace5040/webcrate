#!/bin/bash

SCRIPT=`realpath $0`
SCRIPTPATH=`dirname $SCRIPT`
cd $SCRIPTPATH/..
source .env

uid=$(id -u);
gid=$(id -u);
WEBCRATE_UID_env="WEBCRATE_UID=$uid "
WEBCRATE_GID_env="WEBCRATE_GID=$gid "
if [[ $SITES_PATH == /* ]]; then SITES_FOLDER_ABSOLUTE_PATH=$SITES_PATH; else SITES_FOLDER_ABSOLUTE_PATH=$(pwd)/$SITES_PATH; fi

function generatePassword () {
  pass=`docker run --rm ace5040/webcrate-utils:stable /webcrate/pwgen.sh`
  echo "[mysqldump]" > ./var/secrets/$1.cnf
  echo "user=root" >> ./var/secrets/$1.cnf
  echo "password=\"$pass\"" >> ./var/secrets/$1.cnf
  chmod 0600 ./var/secrets/$1.cnf
  echo $pass
}

function initDbFolder () {
  if [[ ! -d "./var/$1" ]] || [ ! "$(ls -A ./var/$1)" ] ; then
      mkdir -p "./var/$1"
      if [[ ! -f "./var/secrets/$1.cnf" ]]; then
        mkdir -p "./var/secrets"
        echo $(generatePassword $1)
      fi
  fi
  echo ''
}

MYSQL_env="MYSQL_ROOT_PASSWORD=\"$(initDbFolder 'mysql')\" "
MYSQL5_env="MYSQL5_ROOT_PASSWORD=\"$(initDbFolder 'mysql5')\" "
POSTGRES_env="POSTGRES_PASSWORD=\"$(initDbFolder 'postgres')\" "

if [[ ! -f "./users.yml" ]] ; then
  cp ./users.yml.example ./users.yml
fi
if [[ ! -f "./services.yml" ]] ; then
  cp ./services.yml.example ./services.yml
fi
if [[ ! -d "./var/mysql" ]] ; then
  mkdir -p "./var/mysql"
fi
if [[ ! -d "./var/ssh" ]] ; then
  mkdir -p "./var/ssh"
fi
if [[ ! -d "./var/mysql5" ]] ; then
  mkdir -p "./var/mysql5"
fi
if [[ ! -d "./var/postgres" ]] ; then
  mkdir -p "./var/postgres"
fi
if [[ ! -d "./var/sites" ]] ; then
  mkdir -p "./var/sites"
fi
if [[ ! -d "./var/duplicity" ]] ; then
  mkdir -p "./var/duplicity"
fi
if [[ ! -d "./var/letsencrypt" ]] ; then
  mkdir -p "./var/letsencrypt"
fi
if [[ ! -d "./var/openssl" ]] ; then
  mkdir -p "./var/openssl"
fi
if [[ ! -d "./var/crontabs" ]] ; then
  mkdir -p "./var/crontabs"
fi
if [[ ! -d "./var/backup" ]] ; then
  mkdir -p "./var/backup"
fi
if [[ ! -d "./var/secrets" ]] ; then
  mkdir -p "./var/secrets"
fi
if [[ ! -d "./var/solr" ]] ; then
  mkdir -p "./var/solr/logs"
  mkdir -p "./var/solr/cores"
fi
if [[ ! -d "./var/influxdb" ]] ; then
  mkdir -p "./var/influxdb"
fi
if [[ ! -d "./var/logs" ]] ; then
  mkdir -p "./var/logs"
fi
grafana_password=''
if [[ ! -d "./var/grafana/data" ]] ; then
  mkdir -p "./var/grafana/data"
  mkdir -p "./var/grafana/log"
  grafana_password=`docker run --rm ace5040/webcrate-utils:stable /webcrate/pwgen.sh`
  echo "user=admin" > ./var/secrets/grafana.secret
  echo "password=\"$grafana_password\"" >> ./var/secrets/grafana.secret
fi
if [[ ! -f "./var/secrets/webcrate-admin.secret" ]] ; then
  admin_password=`docker run --rm ace5040/webcrate-utils:stable /webcrate/pwgen.sh`
  app_secret=`docker run --rm ace5040/webcrate-utils:stable pwgen -nAs1 32 1`
  echo "user=admin" > ./var/secrets/webcrate-admin.secret
  echo "password=$admin_password" >> ./var/secrets/webcrate-admin.secret
  echo "secret=$app_secret" >> ./var/secrets/webcrate-admin.secret
fi

docker run --rm --env-file=$(pwd)/.env \
  -e WEBCRATE_UID=$uid \
  -e WEBCRATE_GID=$gid \
  -v $SITES_FOLDER_ABSOLUTE_PATH:/sites \
  -v $(pwd)/users.yml:/webcrate/users.yml:ro \
  -v $(pwd)/config/nginx-templates:/webcrate/nginx-templates:ro \
  -v $(pwd)/config/php-pool-templates:/webcrate/custom_templates:ro \
  -v $(pwd)/var/letsencrypt:/webcrate/letsencrypt:ro \
  -v $(pwd)/var/openssl:/webcrate/openssl:ro \
  -v webcrate_nginx_configs:/webcrate/nginx_configs \
  -v webcrate_ssl_configs:/webcrate/ssl_configs \
  -v webcrate_php7_pools:/webcrate/php-fpm.d \
  -v webcrate_php73_pools:/webcrate/php73-fpm.d \
  -v webcrate_php5_pools:/webcrate/php56-fpm.d \
  -v webcrate_dnsmasq_hosts:/webcrate/dnsmasq_hosts \
  ace5040/webcrate-utils:stable \
  /webcrate/parse-users.py

docker run --rm --env-file=$(pwd)/.env \
  -v $(pwd)/services.yml:/webcrate/services.yml:ro \
  -v $(pwd)/config/nginx-templates:/webcrate/nginx-templates:ro \
  -v webcrate_nginx_configs:/webcrate/nginx_configs \
  -v webcrate_dnsmasq_hosts:/webcrate/dnsmasq_hosts \
  ace5040/webcrate-utils:stable \
  /webcrate/parse-services.py

bash -c "${MYSQL_env}${MYSQL5_env}${POSTGRES_env}${WEBCRATE_UID_env}${WEBCRATE_GID_env}docker-compose --project-name webcrate up --remove-orphans --no-build -d"

if [[ $grafana_password != '' ]] ; then
  docker exec --user $uid:$gid grafana grafana-cli admin reset-admin-password "$grafana_password"
fi
